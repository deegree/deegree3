:doctype: book
:encoding: utf-8
:toc: macro
:toclevels: 3
:numbered:
:title-logo-image: images/logo.png

= deegree-gml-tools

This documentation contains the description of the command line interface (CLI) `deegreeGmlTool`. The command line utilities based on deegree
can generate SQL DDL scripts and deegree SQLFeatureStore configuration files from GML application schemas. Furthermore the command line supports a
function to load a GML instance document directly into an existing deegree SQLFeatureStore. The CLI supports Oracle (Locator/Spatial) DBMS
and PostgreSQL/PostGIS DBMS. The command line interface is available on the http://www.deegree.org[deegree home page].

== Usage FeatureStoreConfigLoader

[subs="attributes+"]
------------------------------
Usage: java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -schemaUrl=<url_to_schema_file> [options]

arguments:
 -schemaUrl=<url_to_schema_file>, URL or path to schema file

options:
 -format={deegree|ddl|all}, default=deegree
 -srid=<epsg_code>, default=4258
 -idtype={int|uuid}, default=int
 -mapping={relational|blob}, default=relational
 -dialect={postgis|oracle}, default=postgis
 -cycledepth=INT, positive integer value to specify the depth of cycles, default: 0
 -listOfPropertiesWithPrimitiveHref=<path/to/file>, not set by default

------------------------------

The SQL DDL and XML output is written into two separate files in the current directory. The filename of each file is derived from the
schema file name in the given `schemaUrl`.

=== Usage of option listOfPropertiesWithPrimitiveHref

The option `listOfPropertiesWithPrimitiveHref` references a file listing properties which are written with primitive instead of feature mappings.

For example, in some INSPIRE themes codelists values are stored in `xlink:href` attributes. Corresponding to the GML application schema the type is a `gml:ReferenceType`. Usually deegree would handle this as feature mapping but it is recommended to use a primitive mapping here.

Primitive mapping enables direct filtering on those properties with deegree. For example, filtering on INSPIRE codelist hrefs is possible then.

Syntax of content of file:

    {NamespaceURI}localPart

If multiple properties shall use primitive mappings, they must be listed in new lines.

Example:

    {http://inspire.ec.europa.eu/schemas/gn/4.0}nativeness
    {http://inspire.ec.europa.eu/schemas/ps/4.0}designation

=== Examples

==== Example: Generate SQL DDL for INSPIRE Cadastral Parcels 4.0 with UUIDGenerator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -srid=25832 -format=ddl -idtype=uuid -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated file is './CadastralParcels.sql'.    

==== Example: Generate deegree SQLFeatureStore for INSPIRE Cadastral Parcels 4.0 with UUIDGenerator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -srid=25832 -format=deegree -idtype=uuid -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------
    
The generated file is './CadastralParcels.xml'.    

==== Example: Generate SQL DDL for INSPIRE Cadastral Parcels 4.0 with AutoIDGenerator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -srid=25832 -format=ddl -idtype=int -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated file is './CadastralParcels.sql'.

==== Example: Generate deegree SQLFeatureStore for INSPIRE Cadastral Parcels 4.0 with AutoIDGenerator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -srid=25832 -format=deegree -idtype=int -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated file is './CadastralParcels.xml'.

==== Example: Generate deegree SQLFeatureStore and SQL DDL for INSPIRE Cadastral Parcels 4.0 with AutoIDGenerator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -srid=25832 -format=all -idtype=int -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated files are './CadastralParcels.sql' and './CadastralParcels.xml'.

==== Example: Generate deegree SQLFeatureStore and SQL DDL for INSPIRE Cadastral Parcels 4.0 with Blob-Mapping

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -format=all -mapping=blob -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------
    
The generated files are './CadastralParcels.sql' and './CadastralParcels.xml' with Blob-Mapping for PostGIS.    

==== Example: Generate deegree SQLFeatureStore and SQL DDL for INSPIRE Cadastral Parcels 4.0 for Oracle DBMS with Oracle Locator

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -format=all -dialect=oracle -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated files are './CadastralParcels.sql' and './CadastralParcels.xml' with relational mapping for Oracle Locator.

==== Example: Generate deegree SQLFeatureStore for INSPIRE Cadastral Parcels 4.0 with list of properties with primitive href

[subs="attributes+"]
------------------------------
java -jar deegree-gml-tool-{tool-version}.jar FeatureStoreConfigLoader -format=deegree -listOfPropertiesWithPrimitiveHref=<path/to/file> -schemaUrl=https://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

The generated file is './CadastralParcels.xml'. All properties listed in the referenced file are written with primitive instead of feature mappings.

== Usage GmlLoader

The `GmlLoader` can load a GML instance document into a given database using a deegree workspace containing a SQLFeatureStore configuration file. Other configuration files than the SQLFeatureStore configuration and referenced resources in the workspace are ignored but they may exist.
To import a valid, GML-encoded dataset, the instance document must conforms to the application schema and shall contain
a `gml:FeatureCollection` containing multiple `gml:FeatureMember` elements or a `wfs:FeatureCollection` containing multiple `wfs:member`. The `gml:id` of the inserted features are kept.

[subs="attributes+"]
------------------------------
Usage: java -jar deegree-gml-tool-{tool-version}.jar GmlLoader -pathToFile=<path/to/gmlfile> -workspaceName=<workspace_identifier> -sqlFeatureStoreId=<feature_store_identifier> [options]

arguments:
 -pathToFile=<path/to/gmlfile>, the path to the GML file to import
 -workspaceName=<workspace_identifier>, the name of the deegree workspace used for the import. Must be located at default DEEGREE_WORKSPACE_ROOT directory
 -sqlFeatureStoreId=<feature_store_identifier>, the ID of the SQLFeatureStore in the given workspace

options:
 -disabledResources=<urlpatterns>, a comma separated list URL patterns which should not be resolved, not set by default
------------------------------

=== Usage of option disabledResources
This option shall be used to skip the reference resolving for the given list of URL patterns. This option may have a high impact on the performance when importing large amounts of data.

The following example shows how to skip references to codelist namespaces (add this option to the list of arguments):

    -disabledResources=https://registry.gdi-de.org,http://inspire.ec.europa.eu

[NOTE]
====
Using the GmlLoader requires a deegree SQLFeatureStore configuration with a `UUIDGenerator` for all `FIDMapping` elements.
Use the `-idtype=uuid` option when running the FeatureStoreConfigLoader. An GML instance document shall use the exact same
prefix for all `gml:id` attributes as defined in the `FIDMapping:prefix` attribute of the deegree SQLFeatureStore configuration.
====

== Using the CLI behind a proxy

For HTTP set the `http.proxyHost`, `http.proxyPort` and `http.nonProxyHosts` config properties when executing the CLI.

[subs="attributes+"]
------------------------------
java -Dhttp.proxyHost=your-proxy.net -Dhttp.proxyPort=80 -jar deegree-gml-tool-{tool-version}-jar-with-dependencies.jar -format=ddl -idtype=uuid http://inspire.ec.europa.eu/schemas/cp/4.0/CadastralParcels.xsd
------------------------------

